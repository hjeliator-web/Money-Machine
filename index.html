<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Money Machine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
header{position:fixed;top:0;width:100%;height:50px;background:#111;
display:flex;align-items:center;justify-content:space-around;z-index:10}
button{padding:6px 10px;font-size:13px}
canvas{display:block;margin:auto;background:#111;margin-top:50px}
.menu{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#222;padding:15px;border:2px solid #555;display:none}
.skin{width:40px;height:40px;margin:4px;display:inline-block;border:2px solid #555}
.locked{opacity:.3}
.footer{position:fixed;bottom:5px;width:100%;text-align:center;font-size:11px}
.footer a{color:#aaa;margin:0 5px}
</style>
</head>

<body>

<header>
 <span id="hud"></span>
 <button onclick="shoot()">ðŸ”¥</button>
 <button onclick="openShop()">ðŸ›’</button>
</header>

<canvas id="game" width="360" height="600"></canvas>

<!-- SHOP -->
<div id="shop" class="menu">
 <h3>ðŸ›’ Shop</h3>
 <button onclick="watchRewardAd('speed')">âš¡ Speed (1 Ad)</button>
 <h4>ðŸŽ¨ Skins (2 Ads)</h4>
 <div id="skins"></div>
 <br>
 <button onclick="closeShop()">Close</button>
</div>

<!-- GAME OVER -->
<div id="gameover" class="menu">
 <h2>GAME OVER</h2>
 <p id="finalScore"></p>
 <button onclick="watchRewardAd('revive')">ðŸŽ¥ Revive (Ad)</button><br><br>
 <button onclick="restart()">Restart</button>
</div>

<div class="footer">
 <a href="privacy.html">Privacy</a> |
 <a href="terms.html">Terms</a> |
 <a href="contact.html">Contact</a>
</div>

<script>
Telegram.WebApp.expand();

/* ================= ADS CORE (FINAL FIX) ================= */

let monetagLoaded = false;
let adInProgress = false;

function loadMonetag(callback){
  if(monetagLoaded){
    callback();
    return;
  }

  const s = document.createElement("script");
  s.src = "//libtl.com/sdk.js";
  s.dataset.zone = "10388714";
  s.dataset.sdk = "show_10388714";
  s.dataset.auto = "false";
  s.onload = () => {
    monetagLoaded = true;
    callback();
  };
  document.body.appendChild(s);
}

function watchRewardAd(type, skinIndex=null){
  if(adInProgress) return;
  adInProgress = true;

  loadMonetag(() => {
    show_10388714('pop')
      .then(() => giveReward(type, skinIndex))
      .catch(() => {})
      .finally(() => {
        setTimeout(()=>adInProgress=false, 1500);
      });
  });
}

/* ================= GAME DATA ================= */

const colors=["cyan","red","lime","yellow","orange","pink","purple","gold"];
let save=JSON.parse(localStorage.getItem("mmSave"))||{
 coins:0,level:1,speed:6,skin:0,unlocked:[0]
};

let {coins,level,speed,skin,unlocked}=save;
let bullets=[],enemies=[],game=true,skinAds=0;
let player={x:165,y:530,w:30,h:30};

const c=document.getElementById("game");
const ctx=c.getContext("2d");

/* ================= HUD ================= */
function hud(){
 document.getElementById("hud").innerText=`ðŸ’° ${coins} | Lv ${level}`;
 localStorage.setItem("mmSave",JSON.stringify({coins,level,speed,skin,unlocked}));
}
hud();

/* ================= CONTROLS ================= */
function shoot(){bullets.push({x:player.x+12,y:player.y})}
document.onkeydown=e=>{
 if(e.key==="ArrowLeft")player.x-=speed;
 if(e.key==="ArrowRight")player.x+=speed;
 if(e.key===" ")shoot();
};

/* ================= GAME LOOP ================= */
function spawnEnemy(){
 enemies.push({x:Math.random()*330,y:-30,s:25,hp:2,sp:2+level*0.2});
}

function loop(){
 if(!game)return;
 ctx.clearRect(0,0,360,600);

 ctx.fillStyle=colors[skin];
 ctx.fillRect(player.x,player.y,30,30);

 bullets.forEach((b,i)=>{
  b.y-=10;
  ctx.fillStyle="yellow";
  ctx.fillRect(b.x,b.y,5,10);
  if(b.y<0)bullets.splice(i,1);
 });

 enemies.forEach((e,i)=>{
  e.y+=e.sp;
  ctx.fillStyle="orange";
  ctx.fillRect(e.x,e.y,e.s,e.s);

  bullets.forEach((b,bi)=>{
   if(b.x<e.x+e.s&&b.x+5>e.x&&b.y<e.y+e.s){
    bullets.splice(bi,1);
    e.hp--;
    if(e.hp<=0){
     coins+=5;
     enemies.splice(i,1);
    }
   }
  });

  if(player.x<e.x+e.s&&player.x+30>e.x&&player.y<e.y+e.s){
   endGame();
  }
 });

 if(Math.random()<0.03)spawnEnemy();
 level=Math.max(level,Math.floor(coins/50)+1);
 hud();
 requestAnimationFrame(loop);
}
loop();

/* ================= GAME OVER ================= */
function endGame(){
 game=false;
 finalScore.innerText=`Coins: ${coins}`;
 gameover.style.display="block";
}

function restart(){location.reload();}

/* ================= SHOP ================= */
function openShop(){shop.style.display="block";renderSkins();}
function closeShop(){shop.style.display="none";}

/* ================= REWARDS ================= */
function giveReward(type, skinIndex){
 if(type==="speed"){
  speed+=2;
  alert("âš¡ Speed Boosted");
 }
 if(type==="revive"){
  game=true;
  gameover.style.display="none";
  requestAnimationFrame(loop);
 }
 if(type==="skin"){
  skinAds++;
  if(skinAds>=2){
   unlocked.push(skinIndex);
   skin=skinIndex;
   skinAds=0;
   alert("ðŸŽ¨ Skin Unlocked");
  }else{
   alert("Watch 1 more ad");
  }
 }
 hud();
 renderSkins();
}

/* ================= SKINS ================= */
function renderSkins(){
 skins.innerHTML="";
 colors.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="skin"+(unlocked.includes(i)?"":" locked");
  d.style.background=c;
  d.onclick=()=>unlocked.includes(i)?skin=i:watchRewardAd("skin",i);
  skins.appendChild(d);
 });
}
</script>

</body>
</html>
