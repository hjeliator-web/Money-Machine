<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Money Machine</title>

<!-- Telegram Web App -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
 margin:0;
 background:linear-gradient(#6ec6ff,#e0f7fa);
 font-family:Arial;
 text-align:center;
}
canvas{
 background:linear-gradient(#9adfff,#ffffff);
 border-radius:12px;
 border:3px solid #222;
 display:block;
 margin:auto;
}
#hud{
 font-size:15px;
 font-weight:bold;
 padding:6px;
}
button{
 padding:8px 12px;
 margin:3px;
 font-size:14px;
 border-radius:8px;
}
</style>
</head>

<body>

<div id="hud">Loading...</div>
<canvas id="game" width="360" height="480"></canvas>

<div>
<button onclick="shoot()">üî´ Shoot</button>
<button onclick="showMissions()">üéØ Missions</button>
<button onclick="showLeaderboard()">üèÜ Rank</button>
</div>

<script>
// ================= TELEGRAM USER =================
Telegram.WebApp.expand();
let tg = Telegram.WebApp;
let user = tg.initDataUnsafe.user || {};
let username = user.first_name || "Player";
let userid = user.id || Math.floor(Math.random()*99999);

// ================= GAME DATA =================
let coins = Number(localStorage.coins || 0);
let level = Number(localStorage.level || 1);
let kills = Number(localStorage.kills || 0);

// ENERGY
let energy = Number(localStorage.energy ?? 10);

// DAILY REWARD
let today = new Date().toDateString();
if(localStorage.lastReward !== today){
 coins += 50;
 alert("üéÅ Daily Reward: +50 coins");
 localStorage.lastReward = today;
}

// MISSIONS
let mission = JSON.parse(localStorage.mission || "{}");
if(mission.date !== today){
 mission = {date:today, kills:0, done:false};
}

// LEADERBOARD
let board = JSON.parse(localStorage.board || "[]");

// ================= CANVAS =================
const c = document.getElementById("game");
const x = c.getContext("2d");

let bullets=[];
let plane={x:-80,y:80,alive:true};

// ================= FUNCTIONS =================
function save(){
 localStorage.coins=coins;
 localStorage.level=level;
 localStorage.kills=kills;
 localStorage.energy=energy;
 localStorage.mission=JSON.stringify(mission);
 localStorage.board=JSON.stringify(board);
}

function hud(){
 document.getElementById("hud").innerText =
 `üë§ ${username} | ü™ô ${coins} | ‚ö° ${energy} | ‚≠ê ${level}`;
}

function shoot(){
 if(energy<=0){
  alert("‚ö° No energy, wait!");
  return;
 }
 energy--;
 bullets.push({x:180,y:420});
 save(); hud();
}

function showMissions(){
 let txt = "üéØ DAILY MISSION\n";
 txt += "Shoot 5 planes\n";
 txt += `Progress: ${mission.kills}/5\n`;
 txt += mission.done ? "‚úÖ Completed" : "‚ùå Not done";
 alert(txt);
}

function showLeaderboard(){
 updateBoard();
 let txt="üèÜ LEADERBOARD\n";
 board.forEach((p,i)=>{
  txt += `${i+1}. ${p.name} - ${p.coins}\n`;
 });
 alert(txt);
}

function updateBoard(){
 board = board.filter(p=>p.id!==userid);
 board.push({id:userid,name:username,coins:coins});
 board.sort((a,b)=>b.coins-a.coins);
 board = board.slice(0,10);
}

// ENERGY REGEN
setInterval(()=>{
 if(energy<10){
  energy++;
  save(); hud();
 }
},60000);

// ================= GAME LOOP =================
function spawnPlane(){
 plane.x=-80;
 plane.y=60+Math.random()*120;
 plane.alive=true;
}
spawnPlane();

function loop(){
 x.clearRect(0,0,360,480);

 // ground
 x.fillStyle="#4caf50";
 x.fillRect(0,440,360,40);

 // player
 x.font="30px Arial";
 x.fillText("üßë‚ÄçüöÄ",165,420);

 // plane
 if(plane.alive){
  plane.x+=2+level*0.3;
  x.font="30px Arial";
  x.fillText("‚úàÔ∏è",plane.x,plane.y);
  if(plane.x>380) spawnPlane();
 }

 // bullets
 for(let i=bullets.length-1;i>=0;i--){
  bullets[i].y-=7;
  x.font="20px Arial";
  x.fillText("üî•",bullets[i].x,bullets[i].y);

  if(plane.alive &&
     bullets[i].y<plane.y+20 &&
     bullets[i].x>plane.x &&
     bullets[i].x<plane.x+40){

    plane.alive=false;
    bullets.splice(i,1);

    coins+=10;
    kills++;
    mission.kills++;

    if(mission.kills>=5 && !mission.done){
     coins+=100;
     mission.done=true;
     alert("üéØ Mission complete! +100 coins");
    }

    if(kills%5===0) level++;

    save(); hud();
    setTimeout(spawnPlane,800);
  }

  if(bullets[i] && bullets[i].y<0) bullets.splice(i,1);
 }

 requestAnimationFrame(loop);
}

hud();
loop();
</script>

</body>
</html>
