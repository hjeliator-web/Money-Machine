<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Money Machine</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{
 margin:0;
 background:linear-gradient(#6ec6ff,#e0f7fa);
 font-family:Arial;
 text-align:center;
}
canvas{
 background:linear-gradient(#9adfff,#ffffff);
 border-radius:14px;
 border:3px solid #222;
 display:block;
 margin:auto;
}
#hud,#missionBox{
 font-size:14px;
 font-weight:bold;
 padding:6px;
}
button{
 padding:8px 12px;
 margin:3px;
 font-size:14px;
 border-radius:8px;
}
.shake{
 animation:shake 0.15s;
}
@keyframes shake{
 0%{transform:translate(0,0);}
 25%{transform:translate(3px,0);}
 50%{transform:translate(-3px,0);}
 75%{transform:translate(3px,0);}
}
</style>
</head>

<body>

<div id="hud">Loading...</div>
<div id="missionBox">Loading...</div>

<canvas id="game" width="360" height="480"></canvas>

<div>
<button onclick="shoot()">ğŸ”« Shoot</button>
<button onclick="showMissions()">ğŸ¯ Missions</button>
<button onclick="showAd()">ğŸ“º Watch Ad</button>
<button onclick="showLeaderboard()">ğŸ† Rank</button>
</div>

<script>
// ============== TELEGRAM USER ==============
Telegram.WebApp.expand();
let user = Telegram.WebApp.initDataUnsafe.user || {};
let username = user.first_name || "Player";
let userid = user.id || Math.floor(Math.random()*99999);

// ============== GAME DATA ==============
let coins = Number(localStorage.coins || 0);
let level = Number(localStorage.level || 1);
let energy = Number(localStorage.energy ?? 10);

// ============== MISSIONS ==============
let today = new Date().toDateString();
let mission = JSON.parse(localStorage.mission || "{}");
if(mission.date !== today){
 mission = {date:today, planes:0, coins:0, completed:false};
}

// ============== LEADERBOARD ==============
let board = JSON.parse(localStorage.board || "[]");

// ============== CANVAS ==============
const c = document.getElementById("game");
const x = c.getContext("2d");

let bullets=[];
let coinsAnim=[];
let plane={x:-80,y:80,alive:true};

// ============== FUNCTIONS ==============
function save(){
 localStorage.coins=coins;
 localStorage.level=level;
 localStorage.energy=energy;
 localStorage.mission=JSON.stringify(mission);
 localStorage.board=JSON.stringify(board);
}

function updateHUD(){
 document.getElementById("hud").innerText =
 `ğŸ‘¤ ${username} | ğŸª™ ${coins} | âš¡ ${energy} | â­ ${level}`;
 document.getElementById("missionBox").innerText =
 `ğŸ¯ ${mission.planes}/5 âœˆï¸ | ${mission.coins}/50 ğŸª™`;
}

function shoot(){
 if(energy<=0){
  alert("âš¡ No energy!");
  return;
 }
 energy--;
 bullets.push({x:180,y:420});
 save(); updateHUD();
}

// ============== SAFE AD SYSTEM ==============
function showAd(){
 alert("ğŸ“º Watching ad...\n(wait 3 seconds)");
 setTimeout(()=>{
  coins += 50;
  alert("ğŸ Ad reward: +50 coins");
  save(); updateHUD();
 },3000);
}

function showMissions(){
 alert(
 "ğŸ¯ DAILY MISSIONS\n"+
 "âœˆï¸ Shoot 5 planes\n"+
 "ğŸª™ Collect 50 coins\n\n"+
 (mission.completed?"âœ… Completed":"âŒ In progress")
 );
}

function updateBoard(){
 board = board.filter(p=>p.id!==userid);
 board.push({id:userid,name:username,coins:coins});
 board.sort((a,b)=>b.coins-a.coins);
 board = board.slice(0,10);
}

function showLeaderboard(){
 updateBoard();
 let txt="ğŸ† LEADERBOARD\n";
 board.forEach((p,i)=>{
  txt += `${i+1}. ${p.name} - ${p.coins}\n`;
 });
 alert(txt);
}

// ============== ENERGY REGEN ==============
setInterval(()=>{
 if(energy<10){
  energy++;
  save(); updateHUD();
 }
},60000);

// ============== GAME LOOP ==============
function spawnPlane(){
 plane.x=-80;
 plane.y=60+Math.random()*120;
 plane.alive=true;
}
spawnPlane();

function loop(){
 x.clearRect(0,0,360,480);

 // ground
 x.fillStyle="#4caf50";
 x.fillRect(0,440,360,40);

 // player
 x.font="30px Arial";
 x.fillText("ğŸ§‘â€ğŸš€",165,420);

 // plane (smooth)
 if(plane.alive){
  plane.x+=2+level*0.3;
  x.font="30px Arial";
  x.fillText("âœˆï¸",plane.x,plane.y);
  if(plane.x>380) spawnPlane();
 }

 // bullets (animated trail)
 for(let i=bullets.length-1;i>=0;i--){
  bullets[i].y-=8;
  x.font="20px Arial";
  x.fillText("ğŸ”¥",bullets[i].x,bullets[i].y);

  if(plane.alive &&
     bullets[i].y<plane.y+20 &&
     bullets[i].x>plane.x &&
     bullets[i].x<plane.x+40){

    plane.alive=false;
    bullets.splice(i,1);

    // shake effect
    c.classList.add("shake");
    setTimeout(()=>c.classList.remove("shake"),150);

    coins+=10;
    mission.coins+=10;
    mission.planes++;

    coinsAnim.push({x:plane.x,y:plane.y,life:30});

    if(!mission.completed &&
       mission.planes>=5 &&
       mission.coins>=50){
        mission.completed=true;
        coins+=100;
        alert("ğŸ‰ Mission complete! +100 coins");
    }

    if(coins%50===0) level++;

    save(); updateHUD();
    setTimeout(spawnPlane,800);
  }

  if(bullets[i] && bullets[i].y<0) bullets.splice(i,1);
 }

 // coin animation
 for(let i=coinsAnim.length-1;i>=0;i--){
  coinsAnim[i].y -= 1;
  coinsAnim[i].life--;
  x.font="18px Arial";
  x.fillText("ğŸª™",coinsAnim[i].x,coinsAnim[i].y);
  if(coinsAnim[i].life<=0) coinsAnim.splice(i,1);
 }

 requestAnimationFrame(loop);
}

updateHUD();
loop();
</script>

</body>
</html>
